<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!-- $Id$ -->
<muclient>
<plugin
   name="xBroadcast_Tick"
   author="Bast"
   id="aaa70b4680508448e19b8b25"
   language="Lua"
   purpose="Sends updates when the tick comes in from telopts"
   save_state="y"
   date_written="2009-02-010"
   requires="4.37"
   version="6.0"
   >

<description trim="y">
<![CDATA[
[FOR PLUGIN AUTHORS ONLY]

Detects when a tick is sent through telopts

Example:

  function OnPluginBroadcast (msg, id, name, text)
    if id == "aaa70b4680508448e19b8b25" and msg == 1 then
      -- do something on tick
    end
  end

]]>
</description>

</plugin>

<!--  Script  -->

<script>
<![CDATA[
internalrevision = "$Rev$"

dofile (GetPluginInfo (GetPluginID (), 20) .. "luapath.lua")

require "var"
require "pluginhelper"
require "ldplugin"
require "verify"
require "aardutils"

state = -1
statestring = 'unknown'

]]>
</script>

<script>
<![CDATA[

function OnPluginBroadcast (msg, id, name, text)

  if id == '3e7dedbe37e44942dd46d264' then
    if text:find("comm.tick") then
      res, gmcparg = CallPlugin("3e7dedbe37e44942dd46d264","gmcpval","comm.event")
      stuff = assert (loadstring ('return ' .. gmcparg or ""))()

      phelper:broadcast(1)
      if verify_bool(phelper.crontick) and (statestring == 'active' or
                                    statestring == 'sleeping' or
                                    statestring == 'resting') then
        phelper:mdebug("Sending", "cr")
        SendNoEcho("")
      end
    elseif text:find("char.status") then
      res, gmcparg = CallPlugin("3e7dedbe37e44942dd46d264","gmcpval","char")
      char = assert (loadstring ('return ' .. gmcparg or ""))()
      state = char.status.state
      statestring = statestrings[tonumber(state)]
    end    
  end
  phelper:OnPluginBroadcast(msg, id, name, text)
end

function OnPluginInstall ()
  --OnPluginEnable is automatically called by pluginhelper

  phelper:OnPluginInstall()
end -- OnPluginInstall

function OnPluginClose ()

  phelper:OnPluginClose()
end -- OnPluginClose

function OnPluginEnable ()
  phelper:OnPluginEnable()
  ldplugin ("aard_GMCP_handler", "3e7dedbe37e44942dd46d264")

  if IsConnected () then
    CallPlugin("3e7dedbe37e44942dd46d264","Send_GMCP_Packet","request char")
  end -- if already connected
  
end -- OnPluginEnable

function OnPluginDisable ()

  phelper:OnPluginDisable()
end -- OnPluginDisable

function OnPluginConnect ()

  phelper:OnPluginConnect()
end -- function OnPluginConnect

function OnPluginDisconnect ()

  phelper:OnPluginDisconnect()
end -- function OnPluginConnect

function OnPluginSaveState ()

  phelper:OnPluginSaveState()
end -- function OnPluginSaveState

]]>
</script>

<script>
<![CDATA[

phelper:add_setting('crontick', {help="send a cr to mud on a tick", type="bool", default=verify_bool(false)})

phelper:set_default('cmd', 'btick')
phelper:set_default('plugin_colour', 'orange')

phelper:enable()

]]>
</script>
</muclient>
