<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!-- $Id$ -->
<muclient>
<plugin
   name="xBroadcast_State"
   author="Bast"
   id="aaa79afcb20fa11787c5a327"
   language="Lua"
   purpose="Sends updates when the playing state changes"
   save_state="y"
   date_written="2009-02-02"
   requires="4.28"
   version="4.0"
   >

<description trim="y">
<![CDATA[
[FOR PLUGIN AUTHORS ONLY]

Detects when there is a change in state

Example:

  function OnPluginBroadcast (msg, id, name, text)
    if id == "aaa79afcb20fa11787c5a327" then
      state = GetPluginVariable ("aaa79afcb20fa11787c5a327", "state")
      statestring = GetPluginVariable ("aaa79afcb20fa11787c5a327", "statestring")
    end -- playing status changed
  end

To test if you are currently playing (after a reinstall):

  state = GetPluginVariable ("aaa79afcb20fa11787c5a327", "state")

You can also just do:
  state = GetPluginVariable ("aaa79afcb20fa11787c5a327")

and then get the values by:
  state.state
  state.statestring
]]>
</description>

</plugin>

<!--  Script  -->

<script>
<![CDATA[
internalrevision = "$Rev$"

require "var"
require "pluginhelper"
require "ldplugin"

statestrings = {
  [1] = 'login',
  [2] = 'motd',
  [3] = 'active',
  [4] = 'afk',
  [5] = 'note',
  [6] = 'edit',
  [7] = 'page',
  [8] = 'combat',
  [9] = 'sleeping',
  [11] = 'resting',
  [12] = 'running'
  }

var.statestring = statestrings[1]
var.state = 1

]]>
</script>

<script>
<![CDATA[

function OnPluginBroadcast (msg, id, name, text)
  if id == '3e7dedbe37e44942dd46d264' then
    if text:find("char.status") then
      res, gmcparg = CallPlugin("3e7dedbe37e44942dd46d264","gmcpval","char")
      char = assert (loadstring ('return ' .. gmcparg or ""))()
      var.state = char.status.state
      var.statestring = statestrings[tonumber(var.state)]
      phelper:broadcast(var.state)
    end
  end

  phelper:OnPluginBroadcast(msg, id, name, text)
end

function OnPluginInstall ()
  --OnPluginEnable is automatically called by pluginhelper

  phelper:OnPluginInstall()
end -- OnPluginInstall

function OnPluginClose ()

  phelper:OnPluginClose()
end -- OnPluginClose

function OnPluginEnable ()
  ldplugin ("GMCP_handler")

  phelper:OnPluginEnable()
end -- OnPluginEnable

function OnPluginDisable ()

  phelper:OnPluginDisable()
end -- OnPluginDisable

function OnPluginConnect ()

  phelper:OnPluginConnect()
end -- function OnPluginConnect

function OnPluginDisconnect ()

  phelper:OnPluginDisconnect()
end -- function OnPluginConnect

function OnPluginSaveState ()

  phelper:OnPluginSaveState()
end -- function OnPluginSaveState

]]>
</script>

<script>
<![CDATA[

phelper:set_default('cmd', 'bstate')
phelper:set_default('plugin_colour', 'orange')

phelper:enable()

]]>
</script>
</muclient>
