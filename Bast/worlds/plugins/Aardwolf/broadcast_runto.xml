<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!-- $Id$ -->
<muclient>
<plugin
   name="xBroadcast_Runto"
   author="Bast"
   id="aaa7b6edb20fa44565c5a327"
   language="Lua"
   purpose="Sends updates when using runto"
   save_state="y"
   date_written="2009-08-02"
   requires="4.28"
   version="1.0"
   >

<description trim="y">
<![CDATA[
[FOR PLUGIN AUTHORS ONLY]

Detects when there is a change in state

Example:

  function OnPluginBroadcast (msg, id, name, text)
    if id == "aaa7b6edb20fa44565c5a327" then
      if msg == 1 then
        -- runto started
      elseif msg == 2 then
        -- done with runto
      end
    end -- playing status changed
  end

require swalec's Aardwolf_exits_detector
]]>
</description>

</plugin>

<!--  Triggers  -->
<triggers>
  <trigger
   enabled="y"
   regexp="y"
   script="runstart"
   match="^Running to: .*$"
   sequence="100"
  >
  </trigger>
  <trigger
   enabled="n"
   regexp="y"
   script="runend"
   match="^[Exits: .*]$"
   sequence="100"
   group="runtostuff"
  >
  </trigger>
</triggers>

<!--  Script  -->

<script>
<![CDATA[

require "var"
require "pluginhelper"
require 'ldplugin'

runto = false
seenrecall = false
oneexit = false
current_room = ''

function runstart(name, line, wildcards)
  runto = true
  seenrecall = false
  phelper:enabletriggroup("runtostuff", true)
  phelper:broadcast(1)
end

function runend(name, line, wildcards)
  if seenrecall and not oneexit then
    oneexit = true
    return
  end
  if runto and seenrecall then
    phelper:enabletriggroup("runtostuff", false)
    runto = false
    seenrecall = false
    oneexit = false
    phelper:broadcast(2)
  end
end
]]>
</script>

<script>
<![CDATA[

function OnPluginBroadcast (msg, id, name, text)
  if id == "18c24130ab326dc05b49420d" then
    if msg == 2 then
      current_room = GetPluginVariable("18c24130ab326dc05b49420d", "roomname")
      if current_room == 'The Grand City of Aylor (G)' then
        seenrecall = true
      end
    end
  end
  phelper:OnPluginBroadcast(msg, id, name, text)
end

function OnPluginInstall ()
  --OnPluginEnable is automatically called by pluginhelper

  phelper:OnPluginInstall()
end -- OnPluginInstall

function OnPluginClose ()

  phelper:OnPluginClose()
end -- OnPluginClose

function OnPluginEnable ()
  ldplugin ("Aardwolf_Exits_Detector")

  phelper:OnPluginEnable()
end -- OnPluginEnable

function OnPluginDisable ()

  phelper:OnPluginDisable()
end -- OnPluginDisable

function OnPluginConnect ()

  phelper:OnPluginConnect()
end -- function OnPluginConnect

function OnPluginDisconnect ()

  phelper:OnPluginDisconnect()
end -- function OnPluginConnect

function OnPluginSaveState ()

  phelper:OnPluginSaveState()
end -- function OnPluginSaveState

]]>
</script>


<aliases>
  <alias
   name="plugin_parse"
   script="plugin_parse_helper"
   match="nothing"
   enabled="y"
   regexp="y"
   ignore_case="y"
   sequence="110"
   expand_variables="y"
  >
  </alias>
</aliases>

<script>
<![CDATA[

phelper:set_default('cmd', 'brunto')
phelper:set_default('plugin_colour', 'orange')

phelper:enable()

]]>
</script>
</muclient>
