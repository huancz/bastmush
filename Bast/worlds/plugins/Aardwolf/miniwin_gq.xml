<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!-- $Id$ -->
<muclient>
<plugin
   name="miniwin_gq"
   author="Bast"
   id="eee984fd3c00a9e974cd5eb2"
   language="Lua"
   purpose="put gquest targets in  a minwin"
   save_state="y"
   date_written="2009-02-22 21:20:25"
   requires="4.38"
   version="1.0"
   >
<description trim="y">
Redirects the gq to the miniwindow.
</description>

</plugin>


<!--  Get our standard constants -->

<include name="constants.lua"/>

<!--  Script  -->
<script>
<![CDATA[

require 'var'
require "commas"
require 'miniwin'
require 'tprint'
require 'pluginhelper'
require 'ldplugin'

gqwin = Miniwin:new{name="GQ"}
gqwin:set_default('windowpos', 7)
gqwin:set_default('font_size', 7)
gqwin:set_default('font', 'Verdana')
gqwin:set_default('header_height', 0)

gqmobs = {}
gq_text = {}

function build_gq ()

  local texttable = {}

  local style = {}

  -- do nothing if no gquest
  if #gqmobs == 0 then
    return
  end -- if

  -- heading
  style = {}
  style.text = "GQuest: You need to kill:  "
  style.len = #style.text
  style.style = 0
  table.insert (texttable, {style})

  -- list of mobs
  for i, v in ipairs (gqmobs) do
    style = {}
    style.text = v.num .. " : " .. v.name .. " (" .. v.room .. ")"
    style.len = #style.text
    style.style = 0
    table.insert (texttable, {style})
  end -- for

  gq_text = texttable
  gqwin.header_height = 1
  show_gq()

end -- build_gq

function show_gq ()
  -- do nothing if no gq
  if #gq_text == 0 then
    return
  end -- if

  gqwin:enable()
  gqwin:createwin(gq_text)
  gqwin:show(true)
end -- show_quest_text

]]>
</script>

<script>
<![CDATA[

function OnPluginBroadcast (msg, id, name, text)
  if id == "aaa77f81c5408278ccda7100" then
    if msg == 1 then
      -- gquest available
      gqwin.header_height = 0
      gq_text = {"GQuest Available"}
      show_gq()
    elseif msg == 2 then
      print("gquest joined")
      -- gquest joined
      gqwin.header_height = 0
      gq_text = {"GQuest Joined - Waiting"}
      show_gq()
    elseif msg == 3 then
      local pvar = GetPluginVariable(  "aaa77f81c5408278ccda7100", "mobs" )

      -- get the mobs
      loadstring( pvar )()
      gqmobs = mobs
      build_gq()
    elseif msg == 4 or msg == 5 then
      -- reward
      gqwin:disable()
    end

  end -- gq broadcast
  PluginhelperOnPluginBroadcast(msg, id, name, text)
end

function OnPluginInstall ()
  --OnPluginEnable is automatically called by pluginhelper

  PluginhelperOnPluginInstall()
end -- OnPluginInstall

function OnPluginClose()

  PluginhelperOnPluginClose()
end -- OnPluginClose

function OnPluginEnable ()
  ldplugin("broadcast_gq")

  PluginhelperOnPluginEnable()
end -- OnPluginEnable

function OnPluginDisable ()

  PluginhelperOnPluginDisable()
end -- OnPluginDisable

function OnPluginConnect ()

  PluginhelperOnPluginConnect()
end -- OnPluginConnect

function OnPluginDisconnect ()

  PluginhelperOnPluginDisconnect()
end -- function OnPluginConnect

function OnPluginSaveState ()

  PluginhelperOnPluginSaveState()
end -- function OnPluginSaveState

]]>
</script>

<aliases>
  <alias
   name="plugin_parse"
   script="plugin_parse_helper"
   match="nothing"
   enabled="y"
   regexp="y"
   ignore_case="y"
   sequence="110"
   expand_variables="y"
  >
  </alias>
</aliases>

<script>
<![CDATA[

option_set_default('cmd', 'mgq')
option_set_default('plugin_colour', 'steelblue')

window_set(gqwin)

init_plugin_vars()
set_plugin_alias()

]]>

</script>

</muclient>
