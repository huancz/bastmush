<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!-- $Id$ -->
<!-- Saved on Monday, December 01, 2008, 3:08 PM -->
<!-- MuClient version 4.37 -->


<muclient>
<plugin
   name="Aardwolf_Regen"
   author="Bast"
   id="952f716e12d4fb06621b7b25"
   language="Lua"
   purpose="wear a ring of regen at certain times"
   save_state="y"
   date_written="2008-12-01 15:06:56"
   requires="4.37"
   version="1.0"
   >
<description trim="y">
<![CDATA[
This plugin is designed to wear the regen ring in certain rooms and when sleeping
The regen ring must be in your inventory and not in a container

It will wear the regen ring when
  sleeping
  when entering a regen room
    To add a room, go to that room and type "regen add"
  when idling

It will remove the regen ring when
  standing
  when leaving a regen room
  when you stop idling

Requires swalec's aardwolf exit detector
]]>
</description>

</plugin>


<!--  Get our standard constants -->

<include name="constants.lua"/>

<!--  Plugin help  -->

<aliases>
  <alias
   name="sleep"
   script="sleep"
   match="^(sl|sle|slee|sleep)[ ]*[.]*$"
   enabled="y"
   regexp="y"
   ignore_case="y"
   sequence="100"
  >
  </alias>
</aliases>

<script>
<![CDATA[

require "ldplugin"
require "verify"
require "serialize"
require "tprint"
require "var"
require "pluginhelper"
require "commas"

stats = {}
oldstats = {}
status = {}
oldstatus = {}
tryremove = false
trywear = false
clientAFK = false
regenrooms = {}


function check_room(room)
  if not room or not current_room then
    return false
  end
  room = trim(string.gsub(current_room, "%(G%)", ""))
  if regenrooms[room] == 1 then
    return true
  end
  return false
end

function wear_regen()
  if verify_bool(var.off) == true then
    return
  end
  if trywear then
    return
  end
  if not verify_bool(var.regenworn) or tryremove then
    trywear = true
    --DoAfterSpecial (3, 'try_wear()', sendto.script)
    if var.regensn then
      Send("wear " .. var.regensn .. " lfinger")
    else
      Send("wear regen lfinger")
    end
  end
end

function remove_regen()
  if tryremove then
    return
  end
  if verify_bool(var.regenworn) or trywear then
    tryremove = true
    Send("wear " .. var.oldringsn .. " lfinger")
  end
end

function try_wear()
  if not tryremove then
    Send("wear regen lfinger")
  end
end

function sleep(name, line, wildcards)
  wear_regen()
  Send(line)
end

function checkstand()
  if oldstatus.statestring == 'sleeping' and not verify_bool(var.inregen) then
    remove_regen()
  end
end

function add_room(name, line, wildcards)
  plugin_header()
  if current_room == nil then
    ColourNote(RGBColourToName(var.plugin_colour), "black", "Could not get current room")
    ColourNote("", "", "")
    return
  end
  room = trim(string.gsub(current_room, "%(G%)", ""))
  if regenrooms[room] == 1 then
    ColourNote(RGBColourToName(var.plugin_colour), "black", room .. " already in regen list")
    ColourNote("", "", "")
    return
  end

  regenrooms[room] = 1
  ColourNote(RGBColourToName(var.plugin_colour), "black", "Added Room: " .. room)
  ColourNote("", "", "")
  wear_regen()
end

function remove_room(name, line, wildcards)
  plugin_header()
  if current_room == nil then
    ColourNote(RGBColourToName(var.plugin_colour), "black", "Could not get current room")
    ColourNote("", "", "")
    return
  end
  room = trim(string.gsub(current_room, "%(G%)", ""))
  if regenrooms[room] == 1 then
    regenrooms[room] = nil
    ColourNote(RGBColourToName(var.plugin_colour), "black", room .. " removed")
    ColourNote("", "", "")
    remove_regen()
    return
  end

  ColourNote(RGBColourToName(var.plugin_colour), "black", room .. " not in room list")
  ColourNote("", "", "")
end

function show_rooms(name, line, wildcards)
  plugin_header(" Regen Rooms")
  for room,_ in pairs(regenrooms) do
    ColourNote(RGBColourToName(var.plugin_colour), "black", room)
  end
  ColourNote("", "", "")
end

]]>
</script>

<script>
<![CDATA[

function OnPluginBroadcast (msg, id, name, text)

  -- state change
  if id == "aaa79afcb20fa11787c5a327" then
    oldstatus = status
    status = GetPluginVariableList("aaa79afcb20fa11787c5a327")
    if status.statestring == 'active' then
       checkstand()
    end
  elseif id == "18c24130ab326dc05b49420d" then
    if msg == 2 then
      current_room = GetPluginVariable("18c24130ab326dc05b49420d", "roomname")

      oldregen  = verify_bool(var.inregen)
      var.inregen = check_room(current_room)

      if oldregen and verify_bool(var.inregen) then
        return
      end

      if verify_bool(var.inregen) and ((not verify_bool(var.regenworn)) or tryremove) then
        wear_regen()
        return
      end

      if (not verify_bool(var.inregen)) and (verify_bool(var.regenworn) or trywear) then
        remove_regen()
        return
      end

    end

  elseif id == "0e191dc7829ff2ac2433c2d8" then
    if msg == 1 then
      clientAFK = text == "y"
      if clientAFK and status.statestring == 'active' then
        wear_regen()
      elseif (not clientAFK) and not verify_bool(var.inregen) and status.statestring == 'active' then
        remove_regen()
      end
    end
  elseif id == "aaa7dc9ed92ffc6146964abc" then
    loadstring(text)()
    eqitem = item
    if msg == 2 then
      if eqitem.place == "lfinger" then
        if eqitem.name == "Aardwolf Ring of Regeneration" then
          var.regenworn = true
          var.regensn = eqitem.itemsn
          trywear = false
          SaveState()
        end
      end
    elseif msg == 1 then
      if eqitem.place == "lfinger" then
        if eqitem.name ~= "Aardwolf Ring of Regeneration" then
          var.oldringsn = eqitem.itemsn
          var.oldringdesc = eqitem.name
          SaveState()
        elseif eqitem.name == "Aardwolf Ring of Regeneration" then
          var.regenworn = false
          tryremove = false
          SaveState()
        end
      end
    end
  end
  PluginhelperOnPluginBroadcast(msg, id, name, text)
end

function OnPluginInstall ()
  --OnPluginEnable is automatically called by pluginhelper

  assert (loadstring (GetVariable ("regenrooms") or "")) ()

  PluginhelperOnPluginInstall()
end -- OnPluginInstall

function OnPluginClose ()

  PluginhelperOnPluginClose()
end -- OnPluginClose

function OnPluginEnable ()
  if IsConnected () then
      current_room = GetPluginVariable("18c24130ab326dc05b49420d", "roomname")
  end -- if already connected

  ldplugin ("Aardwolf_Exits_Detector")
  ldplugin ("broadcast_state")
  ldplugin ("broadcast_invmon")

  PluginhelperOnPluginEnable()
end -- OnPluginEnable

function OnPluginDisable ()

  PluginhelperOnPluginDisable()
end -- OnPluginDisable

function OnPluginConnect ()

  PluginhelperOnPluginConnect()
end -- function OnPluginConnect

function OnPluginDisconnect ()

  PluginhelperOnPluginDisonnect()
end -- function OnPluginConnect

function OnPluginSaveState ()
  SetVariable ("regenrooms",
               "regenrooms = " .. serialize.save_simple (regenrooms))

  PluginhelperOnPluginSaveState(options_table)
end -- function OnPluginSaveState

]]>
</script>

<!--  Aliases  -->

<aliases>
  <alias
   name="plugin_parse"
   script="plugin_parse_helper"
   match="nothing"
   enabled="y"
   regexp="y"
   ignore_case="y"
   sequence="110"
   expand_variables="y"
  >
  </alias>
</aliases>

<script>
<![CDATA[

add_option('inregen', {help="whether you are in a room in the regen room list", type="bool", default=verify_bool(false), readonly=true})
add_option('regenworn', {help="whether you are wearing a regen ring", type="bool", default=verify_bool(false), readonly=true})
add_option('regensn', {help="the sn for the regen ring", type="string", default="", readonly=true})
add_option('oldringsn', {help="the sn for the old ring", type="string", default="", readonly=true})
add_option('oldringdesc', {help="the description for the old ring", type="string", default="", readonly=true})
add_option('off', {help="turn off wearing ring", type="bool", default=verify_bool(true)})

option_set_default('cmd', 'regen')
option_set_default('plugin_colour', 'orange')

add_cmd('add', {func=add_room, help="add current room as a regen room"})
add_cmd('remove', {func=remove_room, help="remove current room as a regen room"})
add_cmd('show', {func=show_rooms, help="show rooms"})

init_plugin_vars()
set_plugin_alias()

]]>
</script>
</muclient>
